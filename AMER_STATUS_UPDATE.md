# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è Amer Gateway

## ‚úÖ –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ!

### üîÑ –ü–æ—Ç–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:

#### 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞ –Ω–∞ api2.trapay.uk
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø–æ–ª–Ω—è–µ—Ç —Ñ–æ—Ä–º—É –Ω–∞ `payment.php`
- –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –Ω–∞ `payment_backend.php`
- –ü—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∞ 3D Secure —á–µ—Ä–µ–∑ MasterCard API

#### 2. –£—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç–µ–∂ ‚Üí –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ë–î
```php
// payment_backend.php
$this->updatePaymentInMainDB($this->paymentId, [
    'status' => 'PAID',
    'gateway_payment_id' => $transactionId,
    'card_last4' => substr(str_replace(' ', '', $paymentData['cardNumber']), -4),
    'payment_method' => 'card',
    'paid_at' => date('Y-m-d H:i:s'),
    'gateway_response' => json_encode($result)
]);
```

#### 3. Internal API –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
```typescript
// internal.ts - PATCH /internal/payments/:id/update
router.patch('/payments/:id/update', verifyInternalApiKey, async (req, res) => {
  // –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ë–î
  const updatedPayment = await prisma.payment.update({
    where: { id },
    data: filteredUpdateData
  });
})
```

#### 4. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –º–µ—Ä—á–∞–Ω—Ç–∞ (–¥–æ–±–∞–≤–ª–µ–Ω–æ)
–ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ PAID –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è webhook –º–µ—Ä—á–∞–Ω—Ç—É.

## üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- Internal API –∑–∞—â–∏—â—ë–Ω –∫–ª—é—á–æ–º `internal-api-key`
- –¢–æ–ª—å–∫–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –ø–æ–ª—è –º–æ–≥—É—Ç –±—ã—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –≤—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö

## üì° Webhook endpoints –¥–ª—è Amer
```
POST /webhooks/gateway/amer
POST /webhooks/amer  
POST /webhooks/gateways/amer/webhook
```

## üß™ –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞:

### 1. –°–æ–∑–¥–∞—Ç—å payment link —Å Amer gateway
```bash
# –ß–µ—Ä–µ–∑ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å –∏–ª–∏ API
POST /api/payment-links
{
  "gateway": "1110",
  "amount": 100,
  "currency": "USD"
}
```

### 2. –û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É –∏ —Å–æ–≤–µ—Ä—à–∏—Ç—å –ø–ª–∞—Ç–µ–∂
```
https://api2.trapay.uk/payment.php?payment_id=xxx&amount=100&currency=USD
```

### 3. –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã
```
Card Number: 5555555555554444 (MasterCard)
Expiry: 12/25
CVV: 123
Name: Test User
```

### 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏
–°—Ç–∞—Ç—É—Å –¥–æ–ª–∂–µ–Ω –∏–∑–º–µ–Ω–∏—Ç—å—Å—è —Å `PENDING` –Ω–∞ `PAID`

## üîç –õ–æ–≥–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏:
- `payment_backend.php` –ª–æ–≥–∏—Ä—É–µ—Ç —É—Å–ø–µ—à–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏
- Internal API –ª–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- WebhookService –ª–æ–≥–∏—Ä—É–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –º–µ—Ä—á–∞–Ω—Ç—É
- AdminService –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–ª–∞—Ç–µ–∂–µ–π

## ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:
1. ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ —Å Amer gateway
2. ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞ —á–µ—Ä–µ–∑ 3D Secure
3. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —á–µ—Ä–µ–∑ Internal API
4. ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –º–µ—Ä—á–∞–Ω—Ç–∞ —á–µ—Ä–µ–∑ webhook
5. ‚úÖ –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏
6. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

## üöÄ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏:
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –≤ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏
- –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ webhook –¥–æ—à—ë–ª –¥–æ –º–µ—Ä—á–∞–Ω—Ç–∞
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ)
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–º–∏—Å—Å–∏—é gateway
