# Миграция балансов мерчантов

## Описание проблемы

До исправления система добавляла к балансу мерчанта **полную сумму платежа** без вычета комиссии, что приводило к завышенным балансам.

## Что исправлено

1. **Логика обновления баланса при PAID статусе**: Теперь к балансу добавляется сумма ПОСЛЕ вычета комиссии
2. **Логика отмены PAID статуса**: При отмене вычитается та же сумма (после комиссии)
3. **Все расчеты выплат**: Используют актуальные балансы из поля `balance`

## Файлы миграции

### 1. `analyze-balances.js` - Анализ текущего состояния (БЕЗ ИЗМЕНЕНИЙ)
Безопасный скрипт для проверки текущего состояния:
- Показывает расхождения между текущими и правильными балансами
- НЕ ИЗМЕНЯЕТ данные в базе
- Рекомендуется запустить ПЕРЕД миграцией

```bash
node prisma/analyze-balances.js
```

### 2. `migrate-balance-correction.js` - Детальная миграция
Полный скрипт с детальным логированием:
- Показывает разбивку по шлюзам
- Выводит детальную статистику
- Проверяет каждый платеж

```bash
node prisma/migrate-balance-correction.js
```

### 3. `quick-balance-fix.js` - Быстрая корректировка
Упрощенный скрипт для быстрого исправления:
- Минимум логирования
- Быстрое выполнение
- Только итоговые результаты

```bash
node prisma/quick-balance-fix.js
```

## Пример исправления

**До исправления:**
- Платеж 100 USDT через шлюз с 40% комиссией
- К балансу добавлялось: 100 USDT ❌
- Реально мерчант должен получить: 60 USDT ✅

**После исправления:**
- Платеж 100 USDT через шлюз с 40% комиссией  
- К балансу добавляется: 60 USDT ✅
- Комиссия 40 USDT остается у системы

## Ваш пример

**Исходная ситуация:**
- Баланс: 10,000 USDT
- 20 платежей: 10 через шлюз A (40% комиссия), 10 через шлюз B (60% комиссия)

**После двух выплат по 1000 USDT:**
- Первая выплата: 10,000 → 9,000 USDT
- Вторая выплата: 9,000 → 8,000 USDT
- **Итоговый баланс: 8,000 USDT ✅**

## Как запустить

1. **Сначала убедитесь, что исправленный код задеплоен**
2. **Сделайте бэкап базы данных**
3. **Проанализируйте текущее состояние:**

```bash
# Анализ без изменений (рекомендуется сначала)
node prisma/analyze-balances.js
```

4. **Запустите миграцию:**

```bash
# Детальная миграция (рекомендуется)
node prisma/migrate-balance-correction.js

# Или быстрая корректировка
node prisma/quick-balance-fix.js
```

5. **Проверьте результат:**

```bash
# Повторный анализ для проверки
node prisma/analyze-balances.js
```

## Что делает миграция

1. **Пересчитывает заработок мерчанта** на основе всех PAID платежей с учетом комиссий каждого шлюза
2. **Вычитает все выплаты** из рассчитанной суммы
3. **Обновляет поля:**
   - `balance` - текущий доступный баланс
   - `totalPaidOut` - общая сумма всех выплат

## Проверка результатов

После миграции проверьте:
- Суммы в админ панели должны соответствовать реальным балансам
- Статистика выплат должна показывать корректные суммы
- Новые платежи должны корректно обновлять балансы
